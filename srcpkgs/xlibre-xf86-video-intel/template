# Template file for 'xlibre-xf86-video-intel'
# Maintainer: artist for Xlibre
pkgname=xlibre-xf86-video-intel
_pkgname=xf86-video-intel
version=3.0.0.4
revision=1
archs="x86_64 aarch64"
build_style=gnu-configure
configure_args="--with-default-dri=3"
hostmakedepends="automake libtool pkg-config xorg-util-macros"
makedepends="libXScrnSaver-devel libXcursor-devel libXinerama-devel
 libXrandr-devel libXvMC-devel xlibre-xserver-devel pixman-devel xorgproto"
depends="virtual?xserver-abi-video-28_1 mesa-dri"
short_desc="Libre fork of Xorg DDX Intel video driver"
maintainer="tmp"
license="MIT"
homepage="https://github.com/X11Libre"
distfiles="${homepage}/${_pkgname}/archive/refs/tags/${pkgname}-${version}.tar.gz"
checksum=892482d79e5e16a3e312a52e863a5c8d5cd858626d6e988a459b2bec22b2472d
lib32disabled=yes

# Apply hardened build flags from the XLibre project
case "$XBPS_MACHINE" in
 "x86_64")
  CFLAGS=" -march=x86-64"
  ;;
 "aarch64")
  CFLAGS=" -march=armv8-a"
  ;;
 *)
  CFLAGS=" -march=native"
  ;;
esac
CFLAGS+=" -mtune=generic -O2 -pipe -fexceptions -Wp,-D_FORTIFY_SOURCE=3 -Wformat -Werror=format-security"
CFLAGS+=" -fstack-clash-protection -fno-omit-frame-pointer -mno-omit-leaf-frame-pointer"
LDFLAGS=" -Wl,-O1 -Wl,--sort-common -Wl,--as-needed -Wl,-z,lazy -Wl,-z,relro -Wl,-z,pack-relative-relocs"
if [[ $XBPS_MACHINE != 'aarch64' ]]; then
 CFLAGS+=" -fcf-protection"
fi
# Specific flags for xf86-video-intel
CFLAGS+=" -fno-lto"
LDFLAGS+=" -fno-lto"
CXXFLAGS="${CFLAGS} -Wp,-D_GLIBCXX_ASSERTIONS"

pre_configure() {
	# Force regeneration of configure script
	NOCONFIGURE=1 ./autogen.sh
}

post_install() {
	# Install the license file
	vlicense COPYING
}

xlibre-xf86-video-intel-devel_package() {
	lib32disabled=yes
	depends="${makedepends}"
	short_desc+=" - development files"
	pkg_install() {
		vlicense COPYING
		vmove usr/include
		vmove usr/lib/pkgconfig
	}
}
